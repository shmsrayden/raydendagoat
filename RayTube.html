<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayTube - Custom Video Sharing Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a consistent look */
        body {
            font-family: "Inter", sans-serif;
        }
        /* Ensure video player maintains aspect ratio */
        .aspect-video {
            aspect-ratio: 16 / 9;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-white flex flex-col">

    <header class="bg-gray-800 p-4 shadow-md flex justify-between items-center rounded-b-lg">
        <h1 class="text-3xl font-bold text-red-500">RayTube</h1>
        <div class="flex items-center space-x-4">
            <span id="userIdDisplay" class="text-sm text-gray-300 hidden"></span>

            <select id="pageSelect" class="bg-gray-700 text-white py-2 px-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 ease-in-out">
                <option value="">Select a Page</option>
                <option value="index.html">Home</option>
                <option value="GamesImStaffIn.html">Games Im Staff In</option>
                <option value="AboutMe.html">About Me</option>
                <option value="tutorials.html">Tutorials</option>
                <option value="quotes.html">Quotes</option>
                <option value="PingPong.html">PingPong</option>
                <option value="thingoftheday.html">thing of the day</option>
                <option value="RayTube.html">RayTube (current)</option>
            </select>

            <div id="authButtons" class="flex space-x-4">
                <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Login
                </button>
                <button id="signupBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Sign Up
                </button>
            </div>
            <div id="userActionButtons" class="flex space-x-4 hidden">
                <button id="uploadVideoBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out" disabled>
                    Upload Video
                </button>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out" disabled>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col lg:flex-row p-4 gap-4">
        <section class="lg:w-2/3 bg-gray-800 rounded-lg p-6 shadow-xl flex flex-col items-center justify-center">
            <div id="videoPlayerContainer" class="w-full max-w-full h-auto rounded-lg mb-4 aspect-video bg-black flex items-center justify-center">
                <video id="videoPlayer" controls class="w-full h-full rounded-lg hidden"></video>
                <div id="noVideoSelected" class="text-gray-400 text-xl">Select a video to play</div>
            </div>
            <h2 id="videoTitleDisplay" class="text-2xl font-bold text-white mb-2 text-center hidden"></h2>
            <p id="videoDescriptionDisplay" class="text-gray-300 text-center hidden"></p>
            <p id="videoUploaderDisplay" class="text-sm text-gray-500 mt-2 hidden"></p>
        </section>

        <section class="lg:w-1/3 bg-gray-800 rounded-lg p-6 shadow-xl overflow-y-auto max-h-[calc(100vh-120px)]">
            <h2 class="text-2xl font-bold text-white mb-4">Available Videos</h2>
            <div id="videoList" class="grid grid-cols-1 gap-4">
                <p id="noVideosMessage" class="text-gray-400">No videos uploaded yet. Be the first!</p>
            </div>
        </section>
    </main>

    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="authModalTitle" class="text-xl font-semibold text-gray-800"></h3>
                <button id="closeAuthModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="emailInput" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input
                        type="email"
                        id="emailInput"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    />
                </div>
                <div>
                    <label for="passwordInput" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input
                        type="password"
                        id="passwordInput"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    />
                </div>
                <p id="authErrorMessage" class="text-red-500 text-xs italic hidden"></p>
                <div class="flex items-center justify-between">
                    <button
                        type="submit"
                        id="authSubmitBtn"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                    >
                        Login
                    </button>
                    <button
                        type="button"
                        id="toggleAuthModeBtn"
                        class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800"
                    >
                        Need an account? Sign Up
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Upload New Video</h3>
                <button id="closeUploadModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <form id="uploadVideoForm" class="space-y-4">
                <div>
                    <label for="videoTitleInput" class="block text-gray-700 text-sm font-bold mb-2">Video Title:</label>
                    <input
                        type="text"
                        id="videoTitleInput"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    />
                </div>
                <div>
                    <label for="videoDescriptionInput" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                    <textarea
                        id="videoDescriptionInput"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        rows="3"
                    ></textarea>
                </div>
                <div>
                    <label for="videoUrlInput" class="block text-gray-700 text-sm font-bold mb-2">Video URL (MP4, WebM, etc.):</label>
                    <input
                        type="url"
                        id="videoUrlInput"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        placeholder="e.g., https://www.w3schools.com/html/mov_bbb.mp4"
                        required
                    />
                </div>
                <p id="uploadMessageDisplay" class="text-red-500 text-xs italic hidden"></p>
                <div class="flex justify-end">
                    <button
                        type="submit"
                        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                    >
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and application state
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let isLoginMode = true; // true for login, false for signup

        // Firebase configuration (using your provided details)
        const firebaseConfig = {
            apiKey: "AIzaSyABgTJWKNNOwgUmhQ4fWHo9vNikitJ79mg",
            authDomain: "raytube-f6f90.firebaseapp.com",
            projectId: "raytube-f6f90",
            storageBucket: "raytube-f6f90.firebasestorage.app",
            messagingSenderId: "645586855837",
            appId: "1:645586855837:web:7b4254604fdf99713b7174",
            measurementId: "G-XSK1VZF3QK"
        };

        // Deriving appId directly from firebaseConfig
        const appId = firebaseConfig.appId;

        // Set to null if you are not using custom tokens, otherwise provide your token
        const initialAuthToken = null;

        // --- DOM Element References ---
        const userIdDisplay = document.getElementById('userIdDisplay');
        const pageSelect = document.getElementById('pageSelect'); // Reference to the select menu
        const authButtons = document.getElementById('authButtons');
        const userActionButtons = document.getElementById('userActionButtons');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const uploadVideoBtn = document.getElementById('uploadVideoBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        const videoPlayer = document.getElementById('videoPlayer');
        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const noVideoSelected = document.getElementById('noVideoSelected');
        const videoTitleDisplay = document.getElementById('videoTitleDisplay');
        const videoDescriptionDisplay = document.getElementById('videoDescriptionDisplay');
        const videoUploaderDisplay = document.getElementById('videoUploaderDisplay');
        const videoListDiv = document.getElementById('videoList');
        const noVideosMessage = document.getElementById('noVideosMessage');

        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
        const authForm = document.getElementById('authForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authErrorMessage = document.getElementById('authErrorMessage');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const toggleAuthModeBtn = document.getElementById('toggleAuthModeBtn');

        const uploadModal = document.getElementById('uploadModal');
        const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
        const uploadVideoForm = document.getElementById('uploadVideoForm');
        const videoTitleInput = document.getElementById('videoTitleInput');
        const videoDescriptionInput = document.getElementById('videoDescriptionInput');
        const videoUrlInput = document.getElementById('videoUrlInput');
        const uploadMessageDisplay = document.getElementById('uploadMessageDisplay');

        // --- Utility Functions for UI ---

        /**
         * Shows a modal by removing the 'hidden' class and explicitly setting display to flex.
         * @param {HTMLElement} modalElement - The modal DOM element.
         */
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.style.display = 'flex'; // Ensure it's displayed as flex
        }

        /**
         * Hides a modal by adding the 'hidden' class and explicitly setting display to none.
         * @param {HTMLElement} modalElement - The modal DOM element.
         */
        function hideModal(modalElement) {
            modalElement.classList.add('hidden');
            modalElement.style.display = 'none'; // Ensure it's hidden
        }

        /**
         * Displays an error message in a specified element.
         * @param {HTMLElement} element - The DOM element to display the message in.
         * @param {string} message - The message to display.
         */
        function displayMessage(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        /**
         * Hides an error message in a specified element.
         * @param {HTMLElement} element - The DOM element whose message to hide.
         */
        function hideMessage(element) {
            element.textContent = '';
            element.classList.add('hidden');
        }

        /**
         * Updates the visibility and enabled state of authentication and user action buttons based on login status and auth readiness.
         */
        function updateHeaderButtons() {
            // First, control visibility based on login state
            if (currentUserId && auth.currentUser && !auth.currentUser.isAnonymous) {
                // User is logged in (not anonymous)
                authButtons.classList.add('hidden');
                userActionButtons.classList.remove('hidden');
                userIdDisplay.textContent = `User ID: ${currentUserId}`;
                userIdDisplay.classList.remove('hidden');

                // Explicitly enable user action buttons if auth is ready
                if (isAuthReady) {
                    uploadVideoBtn.disabled = false;
                    logoutBtn.disabled = false;
                }
            } else {
                // User is anonymous or logged out
                authButtons.classList.remove('hidden');
                userActionButtons.classList.add('hidden');
                userIdDisplay.textContent = `User ID: ${currentUserId}`;
                userIdDisplay.classList.remove('hidden'); // Always show user ID for debugging/identification

                // Explicitly enable auth buttons if auth is ready
                if (isAuthReady) {
                    loginBtn.disabled = false;
                    signupBtn.disabled = false;
                }
            }
        }

        // --- Firebase Initialization ---

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("User signed in:", currentUserId);
                    } else {
                        // Sign in anonymously if no user is logged in and no initial token is provided
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                                console.log("Signed in with custom token.");
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth);
                                currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                                console.log("Signed in anonymously due to custom token error.");
                            }
                        } else {
                            await signInAnonymously(auth);
                            currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                            console.log("Signed in anonymously.");
                        }
                    }
                    isAuthReady = true; // Authentication state is ready
                    updateHeaderButtons(); // Update buttons after auth state is determined
                    fetchVideos(); // Start fetching videos once auth is ready
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                displayMessage(authErrorMessage, "Failed to initialize Firebase. Check console for details.");
            }
        }

        // --- Video Management Functions ---

        /**
         * Fetches videos from Firestore and renders them in the list.
         */
        function fetchVideos() {
            if (!db || !isAuthReady) {
                console.warn("Firestore not ready or authentication not complete. Cannot fetch videos.");
                return;
            }

            const videosColRef = collection(db, `artifacts/${appId}/public/data/videos`);

            // Use onSnapshot to listen for real-time updates
            onSnapshot(videosColRef, (snapshot) => {
                videoListDiv.innerHTML = ''; // Clear existing videos
                const fetchedVideos = [];
                snapshot.forEach(doc => {
                    fetchedVideos.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                if (fetchedVideos.length === 0) {
                    noVideosMessage.classList.remove('hidden');
                    videoListDiv.appendChild(noVideosMessage);
                } else {
                    noVideosMessage.classList.add('hidden');
                    fetchedVideos.forEach(video => {
                        const videoCard = document.createElement('div');
                        videoCard.className = 'bg-gray-700 p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-600 transition duration-200 ease-in-out';
                        videoCard.innerHTML = `
                            <h3 class="text-xl font-semibold text-white truncate">${video.title}</h3>
                            <p class="text-gray-400 text-sm line-clamp-2">${video.description || 'No description provided.'}</p>
                        `;
                        videoCard.addEventListener('click', () => handleVideoClick(video));
                        videoListDiv.appendChild(videoCard);
                    });
                }
                console.log("Fetched and rendered videos.");
            }, (error) => {
                console.error("Error fetching videos:", error);
            });
        }

        /**
         * Handles playing a selected video.
         * @param {object} video - The video object to play.
         */
        function handleVideoClick(video) {
            videoPlayer.src = video.url;
            videoPlayer.load(); // Load the new video source
            videoPlayer.play(); // Start playing

            // Update video details display
            videoTitleDisplay.textContent = video.title;
            videoDescriptionDisplay.textContent = video.description || 'No description provided.';
            videoUploaderDisplay.textContent = `Uploader: ${video.uploaderId}`;

            // Show video player and details, hide "select a video" message
            videoPlayer.classList.remove('hidden');
            videoTitleDisplay.classList.remove('hidden');
            videoDescriptionDisplay.classList.remove('hidden');
            videoUploaderDisplay.classList.remove('hidden');
            noVideoSelected.classList.add('hidden');
        }

        /**
         * Handles the submission of the video upload form.
         * @param {Event} e - The form submission event.
         */
        async function handleUploadVideo(e) {
            e.preventDefault();
            hideMessage(uploadMessageDisplay);

            if (!db || !currentUserId) {
                displayMessage(uploadMessageDisplay, "Database not ready or user not logged in.");
                return;
            }

            const title = videoTitleInput.value.trim();
            const description = videoDescriptionInput.value.trim();
            const url = videoUrlInput.value.trim();

            if (!title || !url) {
                displayMessage(uploadMessageDisplay, "Please provide a video title and URL.");
                return;
            }

            try {
                const videosColRef = collection(db, `artifacts/${appId}/public/data/videos`);
                await addDoc(videosColRef, {
                    title: title,
                    description: description,
                    url: url,
                    uploaderId: currentUserId,
                    timestamp: new Date().toISOString()
                });
                displayMessage(uploadMessageDisplay, "Video uploaded successfully!");
                // Clear form fields
                videoTitleInput.value = '';
                videoDescriptionInput.value = '';
                videoUrlInput.value = '';
                // Hide the modal after a short delay to show success message
                setTimeout(() => hideModal(uploadModal), 1500);
            } catch (error) {
                console.error("Error uploading video:", error);
                displayMessage(uploadMessageDisplay, "Failed to upload video: " + error.message);
            }
        }

        // --- Authentication Functions ---

        /**
         * Handles user authentication (login or signup).
         * @param {Event} e - The form submission event.
         */
        async function handleAuth(e) {
            e.preventDefault();
            hideMessage(authErrorMessage);

            // Ensure auth is initialized before proceeding
            if (!auth || !isAuthReady) {
                displayMessage(authErrorMessage, "Firebase Auth not initialized. Please wait a moment.");
                return;
            }

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("User logged in successfully!");
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    console.log("User signed up successfully!");
                }
                hideModal(authModal); // Close modal on success
                updateHeaderButtons(); // Update buttons after successful auth
            } catch (error) {
                console.error("Authentication error:", error);
                displayMessage(authErrorMessage, error.message);
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (auth) {
                try {
                    await signOut(auth);
                    currentUserId = null;
                    // Clear selected video display
                    videoPlayer.pause();
                    videoPlayer.removeAttribute('src');
                    videoPlayer.classList.add('hidden');
                    videoTitleDisplay.classList.add('hidden');
                    videoDescriptionDisplay.classList.add('hidden');
                    videoUploaderDisplay.classList.add('hidden');
                    noVideoSelected.classList.remove('hidden');

                    updateHeaderButtons(); // Update buttons after logout
                    console.log("User logged out.");
                } catch (error) {
                    console.error("Error logging out:", error);
                    displayMessage(authErrorMessage, "Failed to log out."); // Consider a different message display for logout errors
                }
            }
        }

        // --- Event Listeners ---

        // Authentication modal controls
        loginBtn.addEventListener('click', () => {
            isLoginMode = true;
            authModalTitle.textContent = "Login";
            authSubmitBtn.textContent = "Login";
            toggleAuthModeBtn.textContent = "Need an account? Sign Up";
            hideMessage(authErrorMessage);
            showModal(authModal);
        });

        signupBtn.addEventListener('click', () => {
            isLoginMode = false;
            authModalTitle.textContent = "Sign Up";
            authSubmitBtn.textContent = "Sign Up";
            toggleAuthModeBtn.textContent = "Already have an account? Login";
            hideMessage(authErrorMessage);
            showModal(authModal);
        });

        closeAuthModalBtn.addEventListener('click', () => hideModal(authModal));
        authForm.addEventListener('submit', handleAuth);
        toggleAuthModeBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            authModalTitle.textContent = isLoginMode ? "Login" : "Sign Up";
            authSubmitBtn.textContent = isLoginMode ? "Login" : "Sign Up";
            toggleAuthModeBtn.textContent = isLoginMode ? "Need an account? Sign Up" : "Already have an account? Login";
            hideMessage(authErrorMessage); // Clear error message when switching modes
            emailInput.value = ''; // Clear fields when switching modes
            passwordInput.value = '';
        });

        // Upload video modal controls
        uploadVideoBtn.addEventListener('click', () => {
            hideMessage(uploadMessageDisplay);
            videoTitleInput.value = '';
            videoDescriptionInput.value = '';
            videoUrlInput.value = '';
            showModal(uploadModal);
        });
        closeUploadModalBtn.addEventListener('click', () => hideModal(uploadModal));
        uploadVideoForm.addEventListener('submit', handleUploadVideo);

        // Logout button
        logoutBtn.addEventListener('click', handleLogout);

        // Event listener for the page select menu
        pageSelect.addEventListener('change', (event) => {
            const selectedPage = event.target.value;
            if (selectedPage) { // Only navigate if a valid option is selected
                window.location.href = selectedPage;
            }
        });

        // --- Initialize the Application ---
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
